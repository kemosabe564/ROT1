% initialize FPGA
close all;
clear x*;
fugiboard('CloseAll');
h=fugiboard('Open', 'pendulum1');
h.WatchdogTimeout = 1;
fugiboard('SetParams', h);
fugiboard('Write', h, 0, 0, [0 0]);  % dummy write to sync interface board
fugiboard('Write', h, 4+1, 1, [0 0]);  % get version, reset position, activate relay
data = fugiboard('Read', h);
model = bitshift(data(1), -4);
version = bitand(data(1), 15);
disp(sprintf('FPGA setup %d,  version %d', model, version));
fugiboard('Write', h, 0, 1, [0 0]);  % end reset

pause(0.1); % give relay some time to act

%TODO: pos1

% we could use the following to create the effect of stop and continue
disp("place the beam/pend to 180/0 and press Enter")
waitforbuttonpress();

steps = 1000;
beam_temp = 0;
pend_temp = 0;
% steps = 500

xstat = zeros(1,steps);
xreltime = zeros(1,steps);
xpos1 = zeros(1,steps);
xpos2 = zeros(1,steps);
xcurr = zeros(1,steps);
xbeam = zeros(1,steps);
xpend = zeros(1,steps);
xdigin = zeros(1,steps);
tic;
bt = toc;
for X=1:steps

%     if (X > 500)
%         fugiboard('Write', h, 0, 1, [0.0 0.0]);
%     else
%         fugiboard('Write', h, 0, 7, [0.0 0.0]);
%     end
    fugiboard('Write', h, 0, 1, [0.0 2.0]);
    data = fugiboard('Read', h);
    xstat(X) = data(1);
    xreltime(X) = data(2);
    xpos1(X) = data(3);
    xpos2(X) = data(4);
    xcurr(X) = data(5);
    xbeam(X) = data(6);
    xpend(X) = data(7);
    xdigin(X) = data(8);
    t = bt + (0.001 * X);
    %t = toc + 0.005;
    
    beam_temp = beam_temp + data(6);
    pend_temp = pend_temp + data(7);
    while (toc < t); end;
end
beam_temp = beam_temp / steps
pend_temp = pend_temp / steps
toc;
% TODO: calib, get the gamma_0 and gamma_1




% disp("place the beam/pend to 0/180 and press Enter")
% waitforbuttonpress();
% 
% %TODO: pos2
% beam_temp = 0;
% pend_temp = 0;
% 
% tic;
% bt = toc;
% for X=1:steps
% 
% %     if (X > 500)
% %         fugiboard('Write', h, 0, 1, [0.0 0.0]);
% %     else
% %         fugiboard('Write', h, 0, 7, [0.0 0.0]);
% %     end
%     fugiboard('Write', h, 0, 1, [0.0 0.0]);
%     data = fugiboard('Read', h);
%     xstat(X) = data(1);
%     xreltime(X) = data(2);
%     xpos1(X) = data(3);
%     xpos2(X) = data(4);
%     xcurr(X) = data(5);
%     xbeam(X) = data(6);
%     xpend(X) = data(7);
%     xdigin(X) = data(8);
%     t = bt + (0.001 * X);
%     %t = toc + 0.005;
%     
%     beam_temp = beam_temp + data(6);
%     pend_temp = pend_temp + data(7);
%     while (toc < t); end;
% end
% beam_temp = beam_temp / steps
% pend_temp = pend_temp / steps



% plot the figure of pos2

%fugiboard('Write', h, 0, 0, [0.0 0.0]);
figure(1); stairs([xpos1; xpos2]'); ylabel('Position1, Position2');
figure(2); stairs(xcurr); ylabel('Current');
figure(3); stairs([xbeam; xpend]'); ylabel('Beam, Pendulum');
figure(4); stairs(xdigin); ylabel('DigIN');
